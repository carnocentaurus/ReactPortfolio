// Pokedex.tsx

import { type FC, useState } from "react";


const Pokedex: FC = () => {
    const [activeTab, setActiveTab] = useState("random");
    const [randomPokemonSprite, setRandomPokemonSprite] = useState("");
    const [randomPokemonInfo, setRandomPokemonInfo] = useState("");

    const [searchPokemonNameOrId, setSearchPokemonNameOrId] = useState("");
    const [searchPokemonSprite, setSearchPokemonSprite] = useState("");
    const [searchPokemonInfo, setSearchPokemonInfo] = useState("");


    function formatPokemonInfo(
        pokemonId: number,
        pokemonName: string,
        pokemonHeight: number,
        pokemonWeight: number,
        pokemonType: any
    ) {
        pokemonName.charAt(0).toUpperCase() + pokemonName.slice(1);

        // convert to meters and kg
        pokemonHeight = pokemonHeight / 10;
        pokemonWeight = pokemonWeight / 10;

        // map through each type and join them
        pokemonType = pokemonType.map(type => {
            const name: string = type.type.name;
            return name.charAt(0).toUpperCase() + name.slice(1);
        }).join("<br>");

        return `<p>#${pokemonId}</p>
        <p>${pokemonName}</p>
        <p>Height: ${pokemonHeight}M</p>
        <p>Weight: ${pokemonWeight}KG</p>
        <label>Type</label>
        <p>${pokemonType}</p>`;
    }


    async function fetchRandomPokemon() {
        try {
            const min: number = 1;
            const max: number = 1025;

            const randomPokemonId: number = Math.floor(Math.random() * max - min + 1) + min;

            const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomPokemonId}`);

            if (!response.ok) {
                throw new Error();
            }

            const data = await response.json();

            const randomPokemonSprite = data.sprites.front_default;

            const randomPokemonData = {
                id: data.id,
                name: data.name,
                height: data.height,
                weight: data.weight,
                type: data.types
            }

            setRandomPokemonSprite(randomPokemonSprite);
            setRandomPokemonInfo(formatPokemonInfo(
                randomPokemonData.id,
                randomPokemonData.name,
                randomPokemonData.height,
                randomPokemonData.weight,
                randomPokemonData.type
            ));
        }
        catch (error) {
            alert(error);
        }
    }



    async function fetchPokemonByNameOrId() {
        try {
            const nameOrId: any = searchPokemonNameOrId.toLowerCase();

            if (nameOrId.trim() === "") {
                alert("Enter valid name or ID!");
                return;
            }
            if (nameOrId < 1) {
                alert("1 is the lowest Pokémon ID!");
                return;
            }
            if (nameOrId > 1025) {
                alert("1025 is the highest Pokémon ID!");
                return;
            }

            const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${nameOrId}`);

            if (!response.ok) {
                throw new Error();
            }

            const data = await response.json();

            const searchPokemonSprite = data.sprites.front_default;

            const searchPokemonData = {
                id: data.id,
                name: data.name,
                height: data.height,
                weight: data.weight,
                type: data.types,
            }

            setSearchPokemonSprite(searchPokemonSprite);
            setSearchPokemonInfo(formatPokemonInfo(
                searchPokemonData.id,
                searchPokemonData.name,
                searchPokemonData.height,
                searchPokemonData.weight,
                searchPokemonData.type,
            ));
        }
        catch (error) {
            alert(error);
        }
    }


    return(
        <main>
            <div>
                <p 
                    onClick={() => setActiveTab("random")}
                    className={`text-[#333] font-bold ${activeTab === "random" ? "text-[#333] font-bold" : "text-[#666] font-normal"}`}
                >
                  Random
                </p>
                
                <p 
                    onClick={() => setActiveTab("search")}
                    className={`${activeTab === "search" ? "text-[#333] font-bold" : "text-[#666] font-normal"}`}
                >
                  Search
                </p>
            </div>


            <div className={`${activeTab === "random" ? "block" : "hidden"}`}>
              <img
                  className=""
                  src={randomPokemonSprite}
                  alt="Random Pokemon"
              />
              <p>{randomPokemonInfo}</p>

              <button onClick={fetchRandomPokemon}>Fetch</button>
            </div>


            <div className={`${activeTab === "search" ? "block" : "hidden"}`}>
              <input
                  onChange={(event) => setSearchPokemonNameOrId(event.target.value)}
                  value={searchPokemonNameOrId}
                  className=""
                  type="number"
                  placeholder="Pokemon Name or #"
              />
              <button onClick={fetchPokemonByNameOrId}>Fetch</button>

              <img
                  className=""
                  src={searchPokemonSprite}
                  alt="Pokemon"
              />
              <p>{searchPokemonInfo}</p>
            </div>


        </main>
    );
}


export default Pokedex;